================================================================================
ASU CONNECT - SUPABASE SETUP GUIDE
================================================================================

FILE TO USE: APPLY_THIS_TO_SUPABASE.sql

QUICK SETUP (5 minutes):

1. Open Supabase Project Dashboard
   - Go to https://app.supabase.com
   - Select your ASU Connect project

2. Navigate to SQL Editor
   - Click "SQL Editor" in the left sidebar
   - Click "New Query" button

3. Copy and Paste SQL
   - Open APPLY_THIS_TO_SUPABASE.sql in a text editor
   - Copy ALL content (Ctrl+A / Cmd+A, then copy)
   - Paste into the Supabase SQL Editor text field

4. Execute Query
   - Click the "Run" button
   - Wait for completion (should take 5-30 seconds)
   - Look for green checkmark or success message

5. Verify Success
   - Go to "Table Editor" in sidebar
   - You should see 4 new tables:
     * clubs
     * events
     * club_members
     * event_registrations

================================================================================
WHAT WAS CREATED
================================================================================

TABLES (4):
  - clubs: Main club records
  - events: Event records linked to clubs
  - club_members: Club membership records
  - event_registrations: Event registration records

INDEXES (8):
  - idx_clubs_created_by
  - idx_events_club_id
  - idx_events_created_by
  - idx_events_event_date
  - idx_club_members_club_id
  - idx_club_members_user_id
  - idx_event_registrations_event_id
  - idx_event_registrations_user_id

RLS POLICIES (11 total):
  - 4 policies on clubs table
  - 3 policies on events table
  - 4 policies on club_members table (with recursion fixes)
  - 3 policies on event_registrations table

================================================================================
KEY FEATURES
================================================================================

✓ All tables have Row Level Security (RLS) enabled
✓ All SELECT queries allow public read access
✓ User authentication required for CREATE/UPDATE/DELETE
✓ Club creators have special permissions
✓ Event creators have special permissions
✓ Infinite recursion issues are FIXED
✓ Foreign key cascading deletes enabled
✓ Proper indexes for query performance

================================================================================
IMPORTANT NOTES
================================================================================

1. RECURSION FIXED
   - The club_members RLS policies now query the clubs table instead of
     recursively querying club_members
   - This prevents infinite recursion errors that occurred in v1

2. FOREIGN KEY CASCADING
   - Deleting a club automatically deletes all its events and members
   - Deleting an event automatically deletes all its registrations
   - Deleting a user automatically removes them from all clubs/events

3. PUBLIC READ ACCESS
   - Clubs, events, members, and registrations can be viewed by anyone
   - This is intentional for the ASU Connect app use case
   - Restrict this later if needed

4. TESTING AFTER SETUP
   - Check the app's database functions work correctly
   - Verify you can create clubs/events
   - Verify you can join clubs and register for events
   - Test the API endpoints if you have any

================================================================================
IF SOMETHING GOES WRONG
================================================================================

ERROR: "Relation already exists"
  → The tables already exist. That's okay.
  → You can delete them manually and run again if needed.
  → Or try running in a different database schema.

ERROR: "Permission denied"
  → Make sure you're logged into Supabase with the right project
  → Check you have database admin access

ERROR: "Infinite recursion" warning
  → This should NOT happen with the fixed version
  → If it does, use DROP POLICY to remove old policies first
  → Then re-run this script

ERROR: Foreign key violations
  → Make sure auth.users table exists (it should by default)
  → Check that table creation succeeded before policies

NEED HELP?
  → Check the Supabase dashboard logs
  → Review the SQL Editor output for specific error messages
  → Consult the comment in APPLY_THIS_TO_SUPABASE.sql for details

================================================================================
WHAT'S DIFFERENT FROM V1
================================================================================

INFINITE RECURSION FIX:
  - OLD: club_members policies queried club_members recursively
  - NEW: club_members policies query clubs table instead
  - RESULT: No more "infinite recursion" errors

IMPROVED AUTHORIZATION:
  - Club creators can now properly manage members
  - Event creators can properly manage registrations
  - User self-management (join/leave) still works

SIMPLIFIED POLICIES:
  - 11 total policies (clean, non-redundant)
  - Each policy has a specific purpose
  - No conflicting or redundant checks

================================================================================
